# TMS Staging



## 1.StagingTables设计

### 1.1 设计流程

1. 确定所要导入模块设计范围
2. 通过各表间的关联关系，开发连表查询脚本语句
3. 初步建立StagingTable
4. 对比DV模型，提取出各个派生列（Derived Column）
5. 确定StagingTable结构
6. 开发StagingTable建表简本语句

### 1.2 涉及表

| table             | alias |
| ----------------- | ----- |
| WAYBILL           | w     |
| ORDERS            | o     |
| ASSIGNORDER       | ao    |
| ASSIGNORDERDETAIL | ad    |
| TASKORDERRELATION | tskod |
| TASKMANAGEMENT    | tsk   |

### 1.3 关联查询

```sql
SELECT 
w.ID as w_SEQ
,w.ASSIGNATIONQTY as w_ASSIGNATIONQTY
,w.CODE as w_CODE
,w.CREATETYPE as w_CREATETYPE
,w.CREATEDAT as w_CREATEDAT
,w.CREATEDUSERID as w_CREATEDUSERSEQ
,w.DAY as w_DAY
,w.DEALERNAME as w_DEALERNAME
,w.DESCRIPTION1 as w_DESCRIPTION1
,w.DESCRIPTION2 as w_DESCRIPTION2
,w.MONTH as w_MONTH
,w.OEMREGION as w_OEMREGION
,w.ORGANIZATIONID as w_ORGANIZATIONSEQ
,w.QTY as w_QTY
,w.REGION as w_REGION
,w.STATE as w_STATE
,w.TRANSPORTNR as w_TRANSPORTNR
,w.UPDATEDAT as w_UPDATEDAT
,w.UPDATEDUSERID as w_UPDATEDUSERSEQ
,w.WAYBILLDATE as w_WAYBILLDATE
,w.YEAR as w_YEAR
,w.DEPARTMENTID as w_DEPARTMENTSEQ
,w.ORIGINNAME as w_ORIGINNAME
,w.DESTINATIONNAME as w_DESTINATIONNAME
,w.AGENCYID as w_AGENCYSEQ
,w.DEALERID as w_DEALERSEQ
,w.FREIGHT as w_FREIGHT
,w.PROVINCEID as w_PROVINCESEQ
,w.BACKDATE as w_BACKDATE
,w.RECEIPTDATE as w_RECEIPTDATE
,w.DESCRIPTION as w_DESCRIPTION
,w.BRANDSTR as w_BRANDSTR
,o.ID as o_SEQ
,o.AFTERCARTYPE as o_AFTERCARTYPE
,o.CARTYPE as o_CARTYPE
,o.COLOR as o_COLOR
,o.CREATETYPE as o_CREATETYPE
,o.CREATEDAT as o_CREATEDAT
,o.CREATEDUSERID as o_CREATEDUSERSEQ
,o.DAY as o_DAY
,o.DEALERNAME as o_DEALERNAME
,o.DESCRIPTION1 as o_DESCRIPTION1
,o.DESCRIPTION2 as o_DESCRIPTION2
,o.ISPAYABLE as o_ISPAYABLE
,o.MONTH as o_MONTH
,o.OEMREGION as o_OEMREGION
,o.ORGANIZATIONID as o_ORGANIZATIONSEQ
,o.QTY as o_QTY
,o.REGION as o_REGION
,o.STATE as o_STATE
,o.TRANSPORTNR as o_TRANSPORTNR
,o.UPDATEDAT as o_UPDATEDAT
,o.UPDATEDUSERID as o_UPDATEDUSERSEQ
,o.VIN as o_VIN
,o.YEAR as o_YEAR
,o.WAYBILL_ID as o_WAYBILL_SEQ
,o.ORIGINNAME as o_ORIGINNAME
,o.DESTINATIONNAME as o_DESTINATIONNAME
,o.AGENCYID as o_AGENCYSEQ
,o.BENZORDERID as o_BENZORDERSEQ
,o.PROVINCEID as o_PROVINCESEQ
,ao.ID as ao_SEQ
,ao.CODE as ao_CODE
,ao.CREATEDAT as ao_CREATEDAT
,ao.CREATEDUSERID as ao_CREATEDUSERSEQ
,ao.DAY as ao_DAY
,ao.DESCRIPTION1 as ao_DESCRIPTION1
,ao.DESCRIPTION2 as ao_DESCRIPTION2
,ao.DESTINATIONNAME as ao_DESTINATIONNAME
,ao.ENTRUCKTIME as ao_ENTRUCKTIME
,ao.ISAGENCYORDER as ao_ISAGENCYORDER
,ao.ISORIGINAL as ao_ISORIGINAL
,ao.ISPOOL as ao_ISPOOL
,ao.MONTH as ao_MONTH
,ao.OEMREGION as ao_OEMREGION
,ao.ORDERNR as ao_ORDERNR
,ao.ORGANIZATIONID as ao_ORGANIZATIONSEQ
,ao.ORIGINNAME as ao_ORIGINNAME
,ao.ORIGINALORDERNR as ao_ORIGINALORDERNR
,ao.PLANDATE as ao_PLANDATE
,ao.QTY as ao_QTY
,ao.REALLYCARRIER as ao_REALLYCARRIER
,ao.REGIONNAME as ao_REGIONNAME
,ao.ROUTENAME as ao_ROUTENAME
,ao.SHOULDCARRIER as ao_SHOULDCARRIER
,ao.STATE as ao_STATE
,ao.TYPE as ao_TYPE
,ao.UPDATEDAT as ao_UPDATEDAT
,ao.UPDATEDUSERID as ao_UPDATEDUSERSEQ
,ao.YEAR as ao_YEAR
,ao.DEPARTMENTID as ao_DEPARTMENTSEQ
,ao.SHOULDCARRIERID as ao_SHOULDCARRIERSEQ
,ao.REALLYCARRIERID as ao_REALLYCARRIERSEQ
,ao.REGIONNAMES as ao_REGIONNAMES
,ao.ISSEGMENTED as ao_ISSEGMENTED
,ao.RELATEDORGANIZATION as ao_RELATEDORGANIZATION
,ao.ACTUALORIGINCITYID as ao_ACTUALORIGINCITYSEQ
,ao.ACTUALDESTINATIONCITYID as ao_ACTUALDESTINATIONCITYSEQ
,ao.RELATEDAGENCY as ao_RELATEDAGENCY
,ao.RELATEDAGENCYIDS as ao_RELATEDAGENCYSEQS
,ao.CARRIERDATE as ao_CARRIERDATE
,ao.RELATEDORDERS as ao_RELATEDORDERS
,ao.DESCRIPTION as ao_DESCRIPTION
,ao.BRANDSTR as ao_BRANDSTR
,ad.ID as ad_SEQ
,ad.AFTERCARTYPE as ad_AFTERCARTYPE
,ad.CARTYPE as ad_CARTYPE
,ad.CODE as ad_CODE
,ad.CREATETYPE as ad_CREATETYPE
,ad.CREATEDAT as ad_CREATEDAT
,ad.CREATEDUSERID as ad_CREATEDUSERSEQ
,ad.DAY as ad_DAY
,ad.DEALERNAME as ad_DEALERNAME
,ad.DESCRIPTION as ad_DESCRIPTION
,ad.DESTINATIONNAME as ad_DESTINATIONNAME
,ad.ISSELECTED as ad_ISSELECTED
,ad.MONTH as ad_MONTH
,ad.ORDERID as ad_ORDERSEQ
,ad.ORDERNR as ad_ORDERNR
,ad.ORGANIZATIONID as ad_ORGANIZATIONSEQ
,ad.ORIGINNAME as ad_ORIGINNAME
,ad.PLANDATE as ad_PLANDATE
,ad.REGIONNAME as ad_REGIONNAME
,ad.STATE as ad_STATE
,ad.TRANSPORTNR as ad_TRANSPORTNR
,ad.UPDATEDAT as ad_UPDATEDAT
,ad.UPDATEDUSERID as ad_UPDATEDUSERSEQ
,ad.VIN as ad_VIN
,ad.YEAR as ad_YEAR
,ad.REGIONNAMES as ad_REGIONNAMES
,ad.ISSEGMENTED as ad_ISSEGMENTED
,ad.ASSIGNORDERID as ad_ASSIGNORDERSEQ
,ad.ACTUALORIGINCITYID as ad_ACTUALORIGINCITYSEQ
,ad.ACTUALDESTINATIONCITYID as ad_ACTUALDESTINATIONCITYSEQ
,ad.ENTRUCKTIME as ad_ENTRUCKTIME
,tskod.ID as tskod_SEQ
,tskod.ASSIGNORDERID as tskod_ASSIGNORDERSEQ
,tskod.CODE as tskod_CODE
,tskod.CREATEDAT as tskod_CREATEDAT
,tskod.CREATEDUSERID as tskod_CREATEDUSERSEQ
,tskod.DESCRIPTION as tskod_DESCRIPTION
,tskod.TASKMANAGEMENTID as tskod_TASKMANAGEMENTSEQ
,tskod.UPDATEDAT as tskod_UPDATEDAT
,tskod.UPDATEDUSERID as tskod_UPDATEDUSERSEQ
,tsk.ID as tsk_SEQ
,tsk.ACTUALARRIVALTIME as tsk_ACTUALARRIVALTIME
,tsk.ACTUALDEPARTURETIME as tsk_ACTUALDEPARTURETIME
,tsk.BACKGROUND as tsk_BACKGROUND
,tsk.CARQTY as tsk_CARQTY
,tsk.CARRIERMESSAGE as tsk_CARRIERMESSAGE
,tsk.CHECKDATE as tsk_CHECKDATE
,tsk.CODE as tsk_CODE
,tsk.CREATEDAT as tsk_CREATEDAT
,tsk.CREATEDUSERID as tsk_CREATEDUSERSEQ
,tsk.CURRENTPLACE as tsk_CURRENTPLACE
,tsk.DAY as tsk_DAY
,tsk.DESCRIPTION as tsk_DESCRIPTION
,tsk.DESPATCHPLANINDATE as tsk_DESPATCHPLANINDATE
,tsk.DESTINATIONNAME as tsk_DESTINATIONNAME
,tsk.ENTRUCKINGDATE as tsk_ENTRUCKINGDATE
,tsk.HEAVYDRIVINGTASK as tsk_HEAVYDRIVINGTASK
,tsk.ISCHECK as tsk_ISCHECK
,tsk.ISPAYABLE as tsk_ISPAYABLE
,tsk.MONTH as tsk_MONTH
,tsk.ORGANIZATIONID as tsk_ORGANIZATIONSEQ
,tsk.ORIGINNAME as tsk_ORIGINNAME
,tsk.PLANDATE as tsk_PLANDATE
,tsk.PLANARRIVALTIME as tsk_PLANARRIVALTIME
,tsk.PLANDEPARTURETIME as tsk_PLANDEPARTURETIME
,tsk.QTY as tsk_QTY
,tsk.REALLYCARRIER as tsk_REALLYCARRIER
,tsk.REGIONID as tsk_REGIONSEQ
,tsk.RELATEDWAYBILL as tsk_RELATEDWAYBILL
,tsk.ROUTENAME as tsk_ROUTENAME
,tsk.STATE as tsk_STATE
,tsk.TASKNUMBER as tsk_TASKNUMBER
,tsk.TASKTYPE as tsk_TASKTYPE
,tsk.TRANSEXPECTTIME as tsk_TRANSEXPECTTIME
,tsk.TYPE as tsk_TYPE
,tsk.UPDATEDAT as tsk_UPDATEDAT
,tsk.UPDATEDUSERID as tsk_UPDATEDUSERSEQ
,tsk.YEAR as tsk_YEAR
,tsk.DEPARTMENTID as tsk_DEPARTMENTSEQ
,tsk.DELIVERYCARDATE as tsk_DELIVERYCARDATE
,tsk.RELATEDORGANIZATION as tsk_RELATEDORGANIZATION
,tsk.CARRIERTYPE as tsk_CARRIERTYPE
,tsk.DISTRIBUTIONCARUSERID as tsk_DISTRIBUTIONCARUSERSEQ
,tsk.DISTRIBUTIONCARUSERDATE as tsk_DISTRIBUTIONCARUSERDATE
,tsk.RELATEDAGENCY as tsk_RELATEDAGENCY
,tsk.RELATEDAGENCYIDS as tsk_RELATEDAGENCYSEQS
,tsk.LONGITUDE as tsk_LONGITUDE
,tsk.LATITUDE as tsk_LATITUDE
,tsk.ISGENERATEEMPTY as tsk_ISGENERATEEMPTY
,tsk.ISROLLBACKTASK as tsk_ISROLLBACKTASK
,tsk.RELATEDORDERS as tsk_RELATEDORDERS
,tsk.NEXTCARRIERTYPE as tsk_NEXTCARRIERTYPE
,tsk.BRANDSTR as tsk_BRANDSTR
,tsk.WAYBILLNR as tsk_WAYBILLNR

from WAYBILL w 
LEFT JOIN ORDERS o on (w.transportnr = o.transportnr)
LEFT JOIN ASSIGNORDERDETAIL ad on ( o.VIN = ad.VIN and o.transportnr = ad.transportnr )
LEFT JOIN ASSIGNORDER ao on (AD.ORDERNR=AO.ORDERNR)
LEFT JOIN TASKORDERRELATION tskod on (AO."ID"=TSKOD.ASSIGNORDERID)
LEFT JOIN TASKMANAGEMENT tsk on (TSKOD.TASKMANAGEMENTID=TSK."ID")
where 
-- w.CREATEDAT > TO_DATE('2018-06-01', 'yyyy-mm-dd')
-- w.CREATEDAT > TO_DATE('2018-10-14', 'yyyy-mm-dd')
w.TRANSPORTNR in ('B20180000027310','B20180000027242')
```

### 1.4 Columns From TMS

| 来源 | 字段                        | 类型     | 长度 |
| ---- | --------------------------- | -------- | ---- |
| TMS  | w_SEQ                       | NUMBER   | 19   |
| TMS  | w_ASSIGNATIONQTY            | NUMBER   | 19   |
| TMS  | w_CODE                      | VARCHAR2 | 255  |
| TMS  | w_CREATETYPE                | NUMBER   | 19   |
| TMS  | w_CREATEDAT                 | DATE     | 7    |
| TMS  | w_CREATEDUSERSEQ            | NUMBER   | 19   |
| TMS  | w_DAY                       | NUMBER   | 19   |
| TMS  | w_DEALERNAME                | VARCHAR2 | 255  |
| TMS  | w_DESCRIPTION1              | VARCHAR2 | 255  |
| TMS  | w_DESCRIPTION2              | VARCHAR2 | 255  |
| TMS  | w_MONTH                     | NUMBER   | 19   |
| TMS  | w_OEMREGION                 | VARCHAR2 | 255  |
| TMS  | w_ORGANIZATIONSEQ           | NUMBER   | 19   |
| TMS  | w_QTY                       | NUMBER   | 19   |
| TMS  | w_REGION                    | VARCHAR2 | 255  |
| TMS  | w_STATE                     | NUMBER   | 19   |
| TMS  | w_TRANSPORTNR               | VARCHAR2 | 255  |
| TMS  | w_UPDATEDAT                 | DATE     | 7    |
| TMS  | w_UPDATEDUSERSEQ            | NUMBER   | 19   |
| TMS  | w_WAYBILLDATE               | DATE     | 7    |
| TMS  | w_YEAR                      | NUMBER   | 19   |
| TMS  | w_DEPARTMENTSEQ             | NUMBER   | 19   |
| TMS  | w_ORIGINNAME                | NUMBER   | 19   |
| TMS  | w_DESTINATIONNAME           | NUMBER   | 19   |
| TMS  | w_AGENCYSEQ                 | NUMBER   | 19   |
| TMS  | w_DEALERSEQ                 | NUMBER   | 19   |
| TMS  | w_FREIGHT                   | NUMBER   | 19   |
| TMS  | w_PROVINCESEQ               | NUMBER   | 19   |
| TMS  | w_BACKDATE                  | DATE     | 7    |
| TMS  | w_RECEIPTDATE               | DATE     | 7    |
| TMS  | w_DESCRIPTION               | VARCHAR2 | 255  |
| TMS  | w_BRANDSTR                  | VARCHAR2 | 255  |
| TMS  | o_SEQ                       | NUMBER   | 19   |
| TMS  | o_AFTERCARTYPE              | VARCHAR2 | 255  |
| TMS  | o_CARTYPE                   | VARCHAR2 | 255  |
| TMS  | o_COLOR                     | VARCHAR2 | 255  |
| TMS  | o_CREATETYPE                | NUMBER   | 19   |
| TMS  | o_CREATEDAT                 | DATE     | 7    |
| TMS  | o_CREATEDUSERSEQ            | NUMBER   | 19   |
| TMS  | o_DAY                       | NUMBER   | 19   |
| TMS  | o_DEALERNAME                | VARCHAR2 | 255  |
| TMS  | o_DESCRIPTION1              | VARCHAR2 | 255  |
| TMS  | o_DESCRIPTION2              | VARCHAR2 | 255  |
| TMS  | o_ISPAYABLE                 | NUMBER   | 19   |
| TMS  | o_MONTH                     | NUMBER   | 19   |
| TMS  | o_OEMREGION                 | VARCHAR2 | 255  |
| TMS  | o_ORGANIZATIONSEQ           | NUMBER   | 19   |
| TMS  | o_QTY                       | NUMBER   | 19   |
| TMS  | o_REGION                    | VARCHAR2 | 255  |
| TMS  | o_STATE                     | NUMBER   | 19   |
| TMS  | o_TRANSPORTNR               | VARCHAR2 | 255  |
| TMS  | o_UPDATEDAT                 | DATE     | 7    |
| TMS  | o_UPDATEDUSERSEQ            | NUMBER   | 19   |
| TMS  | o_VIN                       | VARCHAR2 | 255  |
| TMS  | o_YEAR                      | NUMBER   | 19   |
| TMS  | o_WAYBILL_SEQ               | NUMBER   | 19   |
| TMS  | o_ORIGINNAME                | NUMBER   | 19   |
| TMS  | o_DESTINATIONNAME           | NUMBER   | 19   |
| TMS  | o_AGENCYSEQ                 | NUMBER   | 19   |
| TMS  | o_BENZORDERSEQ              | NUMBER   | 19   |
| TMS  | o_PROVINCESEQ               | NUMBER   | 19   |
| TMS  | ao_SEQ                      | NUMBER   | 19   |
| TMS  | ao_CODE                     | VARCHAR2 | 255  |
| TMS  | ao_CREATEDAT                | DATE     | 7    |
| TMS  | ao_CREATEDUSERSEQ           | NUMBER   | 19   |
| TMS  | ao_DAY                      | NUMBER   | 19   |
| TMS  | ao_DESCRIPTION1             | VARCHAR2 | 255  |
| TMS  | ao_DESCRIPTION2             | VARCHAR2 | 255  |
| TMS  | ao_DESTINATIONNAME          | NUMBER   | 19   |
| TMS  | ao_ENTRUCKTIME              | DATE     | 7    |
| TMS  | ao_ISAGENCYORDER            | NUMBER   | 19   |
| TMS  | ao_ISORIGINAL               | NUMBER   | 19   |
| TMS  | ao_ISPOOL                   | NUMBER   | 19   |
| TMS  | ao_MONTH                    | NUMBER   | 19   |
| TMS  | ao_OEMREGION                | VARCHAR2 | 255  |
| TMS  | ao_ORDERNR                  | VARCHAR2 | 255  |
| TMS  | ao_ORGANIZATIONSEQ          | NUMBER   | 19   |
| TMS  | ao_ORIGINNAME               | NUMBER   | 19   |
| TMS  | ao_ORIGINALORDERNR          | VARCHAR2 | 255  |
| TMS  | ao_PLANDATE                 | DATE     | 7    |
| TMS  | ao_QTY                      | NUMBER   | 19   |
| TMS  | ao_REALLYCARRIER            | NUMBER   | 19   |
| TMS  | ao_REGIONNAME               | NUMBER   | 19   |
| TMS  | ao_ROUTENAME                | NUMBER   | 19   |
| TMS  | ao_SHOULDCARRIER            | NUMBER   | 19   |
| TMS  | ao_STATE                    | NUMBER   | 19   |
| TMS  | ao_TYPE                     | NUMBER   | 19   |
| TMS  | ao_UPDATEDAT                | DATE     | 7    |
| TMS  | ao_UPDATEDUSERSEQ           | NUMBER   | 19   |
| TMS  | ao_YEAR                     | NUMBER   | 19   |
| TMS  | ao_DEPARTMENTSEQ            | NUMBER   | 19   |
| TMS  | ao_SHOULDCARRIERSEQ         | NUMBER   | 19   |
| TMS  | ao_REALLYCARRIERSEQ         | NUMBER   | 19   |
| TMS  | ao_REGIONNAMES              | VARCHAR2 | 50   |
| TMS  | ao_ISSEGMENTED              | NUMBER   | 1    |
| TMS  | ao_RELATEDORGANIZATION      | VARCHAR2 | 500  |
| TMS  | ao_ACTUALORIGINCITYSEQ      | NUMBER   | 19   |
| TMS  | ao_ACTUALDESTINATIONCITYSEQ | NUMBER   | 19   |
| TMS  | ao_RELATEDAGENCY            | VARCHAR2 | 500  |
| TMS  | ao_RELATEDAGENCYSEQS        | VARCHAR2 | 500  |
| TMS  | ao_CARRIERDATE              | DATE     | 7    |
| TMS  | ao_RELATEDORDERS            | CLOB     | 4000 |
| TMS  | ao_DESCRIPTION              | VARCHAR2 | 255  |
| TMS  | ao_BRANDSTR                 | VARCHAR2 | 255  |
| TMS  | ad_SEQ                      | NUMBER   | 19   |
| TMS  | ad_AFTERCARTYPE             | VARCHAR2 | 255  |
| TMS  | ad_CARTYPE                  | VARCHAR2 | 255  |
| TMS  | ad_CODE                     | VARCHAR2 | 255  |
| TMS  | ad_CREATETYPE               | NUMBER   | 19   |
| TMS  | ad_CREATEDAT                | DATE     | 7    |
| TMS  | ad_CREATEDUSERSEQ           | NUMBER   | 19   |
| TMS  | ad_DAY                      | NUMBER   | 19   |
| TMS  | ad_DEALERNAME               | VARCHAR2 | 255  |
| TMS  | ad_DESCRIPTION              | VARCHAR2 | 255  |
| TMS  | ad_DESTINATIONNAME          | NUMBER   | 19   |
| TMS  | ad_ISSELECTED               | NUMBER   | 19   |
| TMS  | ad_MONTH                    | NUMBER   | 19   |
| TMS  | ad_ORDERSEQ                 | NUMBER   | 19   |
| TMS  | ad_ORDERNR                  | VARCHAR2 | 255  |
| TMS  | ad_ORGANIZATIONSEQ          | NUMBER   | 19   |
| TMS  | ad_ORIGINNAME               | NUMBER   | 19   |
| TMS  | ad_PLANDATE                 | DATE     | 7    |
| TMS  | ad_REGIONNAME               | NUMBER   | 19   |
| TMS  | ad_STATE                    | NUMBER   | 19   |
| TMS  | ad_TRANSPORTNR              | VARCHAR2 | 255  |
| TMS  | ad_UPDATEDAT                | DATE     | 7    |
| TMS  | ad_UPDATEDUSERSEQ           | NUMBER   | 19   |
| TMS  | ad_VIN                      | VARCHAR2 | 255  |
| TMS  | ad_YEAR                     | NUMBER   | 19   |
| TMS  | ad_REGIONNAMES              | VARCHAR2 | 50   |
| TMS  | ad_ISSEGMENTED              | NUMBER   | 1    |
| TMS  | ad_ASSIGNORDERSEQ           | NUMBER   | 19   |
| TMS  | ad_ACTUALORIGINCITYSEQ      | NUMBER   | 19   |
| TMS  | ad_ACTUALDESTINATIONCITYSEQ | NUMBER   | 19   |
| TMS  | ad_ENTRUCKTIME              | DATE     | 7    |
| TMS  | tskod_SEQ                   | NUMBER   | 19   |
| TMS  | tskod_ASSIGNORDERSEQ        | NUMBER   | 19   |
| TMS  | tskod_CODE                  | VARCHAR2 | 255  |
| TMS  | tskod_CREATEDAT             | DATE     | 7    |
| TMS  | tskod_CREATEDUSERSEQ        | NUMBER   | 19   |
| TMS  | tskod_DESCRIPTION           | VARCHAR2 | 255  |
| TMS  | tskod_TASKMANAGEMENTSEQ     | NUMBER   | 19   |
| TMS  | tskod_UPDATEDAT             | DATE     | 7    |
| TMS  | tskod_UPDATEDUSERSEQ        | NUMBER   | 19   |
| TMS  | tsk_SEQ                     | NUMBER   | 19   |
| TMS  | tsk_ACTUALARRIVALTIME       | DATE     | 7    |
| TMS  | tsk_ACTUALDEPARTURETIME     | DATE     | 7    |
| TMS  | tsk_BACKGROUND              | NUMBER   | 19   |
| TMS  | tsk_CARQTY                  | NUMBER   | 19   |
| TMS  | tsk_CARRIERMESSAGE          | VARCHAR2 | 255  |
| TMS  | tsk_CHECKDATE               | DATE     | 7    |
| TMS  | tsk_CODE                    | VARCHAR2 | 255  |
| TMS  | tsk_CREATEDAT               | DATE     | 7    |
| TMS  | tsk_CREATEDUSERSEQ          | NUMBER   | 19   |
| TMS  | tsk_CURRENTPLACE            | VARCHAR2 | 255  |
| TMS  | tsk_DAY                     | NUMBER   | 19   |
| TMS  | tsk_DESCRIPTION             | VARCHAR2 | 255  |
| TMS  | tsk_DESPATCHPLANINDATE      | DATE     | 7    |
| TMS  | tsk_DESTINATIONNAME         | NUMBER   | 19   |
| TMS  | tsk_ENTRUCKINGDATE          | DATE     | 7    |
| TMS  | tsk_HEAVYDRIVINGTASK        | NUMBER   | 19   |
| TMS  | tsk_ISCHECK                 | NUMBER   | 19   |
| TMS  | tsk_ISPAYABLE               | NUMBER   | 19   |
| TMS  | tsk_MONTH                   | NUMBER   | 19   |
| TMS  | tsk_ORGANIZATIONSEQ         | NUMBER   | 19   |
| TMS  | tsk_ORIGINNAME              | NUMBER   | 19   |
| TMS  | tsk_PLANDATE                | DATE     | 7    |
| TMS  | tsk_PLANARRIVALTIME         | DATE     | 7    |
| TMS  | tsk_PLANDEPARTURETIME       | DATE     | 7    |
| TMS  | tsk_QTY                     | NUMBER   | 19   |
| TMS  | tsk_REALLYCARRIER           | NUMBER   | 19   |
| TMS  | tsk_REGIONSEQ               | NUMBER   | 19   |
| TMS  | tsk_RELATEDWAYBILL          | VARCHAR2 | 255  |
| TMS  | tsk_ROUTENAME               | NUMBER   | 19   |
| TMS  | tsk_STATE                   | NUMBER   | 19   |
| TMS  | tsk_TASKNUMBER              | VARCHAR2 | 255  |
| TMS  | tsk_TASKTYPE                | NUMBER   | 19   |
| TMS  | tsk_TRANSEXPECTTIME         | DATE     | 7    |
| TMS  | tsk_TYPE                    | NUMBER   | 19   |
| TMS  | tsk_UPDATEDAT               | DATE     | 7    |
| TMS  | tsk_UPDATEDUSERSEQ          | NUMBER   | 19   |
| TMS  | tsk_YEAR                    | NUMBER   | 19   |
| TMS  | tsk_DEPARTMENTSEQ           | NUMBER   | 19   |
| TMS  | tsk_DELIVERYCARDATE         | DATE     | 7    |
| TMS  | tsk_RELATEDORGANIZATION     | VARCHAR2 | 500  |
| TMS  | tsk_CARRIERTYPE             | NUMBER   | 19   |
| TMS  | tsk_DISTRIBUTIONCARUSERSEQ  | NUMBER   | 19   |
| TMS  | tsk_DISTRIBUTIONCARUSERDATE | DATE     | 7    |
| TMS  | tsk_RELATEDAGENCY           | VARCHAR2 | 500  |
| TMS  | tsk_RELATEDAGENCYSEQS       | VARCHAR2 | 500  |
| TMS  | tsk_LONGITUDE               | FLOAT    | 126  |
| TMS  | tsk_LATITUDE                | FLOAT    | 126  |
| TMS  | tsk_ISGENERATEEMPTY         | NUMBER   | 19   |
| TMS  | tsk_ISROLLBACKTASK          | NUMBER   | 19   |
| TMS  | tsk_RELATEDORDERS           | VARCHAR2 | 255  |
| TMS  | tsk_NEXTCARRIERTYPE         | NUMBER   | 19   |
| TMS  | tsk_BRANDSTR                | VARCHAR2 | 255  |
| TMS  | tsk_WAYBILLNR               | VARCHAR2 | 3000 |

### 1.5 派生列(Derived Columns)

| 来源    | 字段                | 类型     | 长度 |
| ------- | ------------------- | -------- | ---- |
| Derived | SEQUENCE            | NUMBER   | 19   |
| Derived | LoadDate            | DATE     | 7    |
| Derived | RecordSource        | VARCHAR2 | 255  |
| Derived | WayBillHK           | VARCHAR2 | 50   |
| Derived | OrderHK             | VARCHAR2 | 50   |
| Derived | AssignOrderHK       | VARCHAR2 | 50   |
| Derived | TaskHK              | VARCHAR2 | 50   |
| Derived | WaybillOrderHK      | VARCHAR2 | 50   |
| Derived | AssignOrderDetailHK | VARCHAR2 | 50   |
| Derived | AssignOrderTaskHK   | VARCHAR2 | 50   |

### 1.6 Kudu建表脚本

```SQL
CREATE TABLE tms_stage (
SEQUENCE INT,
LoadDate BIGINT,
w_SEQ INT,
w_ASSIGNATIONQTY INT,
w_CODE STRING,
w_CREATETYPE INT,
w_CREATEDAT BIGINT,
w_CREATEDUSERSEQ INT,
w_DAY INT,
w_DEALERNAME STRING,
w_DESCRIPTION1 STRING,
w_DESCRIPTION2 STRING,
w_MONTH INT,
w_OEMREGION STRING,
w_ORGANIZATIONSEQ INT,
w_QTY INT,
w_REGION STRING,
w_STATE INT,
w_TRANSPORTNR STRING,
w_UPDATEDAT BIGINT,
w_UPDATEDUSERSEQ INT,
w_WAYBILLDATE BIGINT,
w_YEAR INT,
w_DEPARTMENTSEQ INT,
w_ORIGINNAME INT,
w_DESTINATIONNAME INT,
w_AGENCYSEQ INT,
w_DEALERSEQ INT,
w_FREIGHT INT,
w_PROVINCESEQ INT,
w_BACKDATE BIGINT,
w_RECEIPTDATE BIGINT,
w_DESCRIPTION STRING,
w_BRANDSTR STRING,
o_SEQ INT,
o_AFTERCARTYPE STRING,
o_CARTYPE STRING,
o_COLOR STRING,
o_CREATETYPE INT,
o_CREATEDAT BIGINT,
o_CREATEDUSERSEQ INT,
o_DAY INT,
o_DEALERNAME STRING,
o_DESCRIPTION1 STRING,
o_DESCRIPTION2 STRING,
o_ISPAYABLE INT,
o_MONTH INT,
o_OEMREGION STRING,
o_ORGANIZATIONSEQ INT,
o_QTY INT,
o_REGION STRING,
o_STATE INT,
o_TRANSPORTNR STRING,
o_UPDATEDAT BIGINT,
o_UPDATEDUSERSEQ INT,
o_VIN STRING,
o_YEAR INT,
o_WAYBILL_SEQ INT,
o_ORIGINNAME INT,
o_DESTINATIONNAME INT,
o_AGENCYSEQ INT,
o_BENZORDERSEQ INT,
o_PROVINCESEQ INT,
ao_SEQ INT,
ao_CODE STRING,
ao_CREATEDAT BIGINT,
ao_CREATEDUSERSEQ INT,
ao_DAY INT,
ao_DESCRIPTION1 STRING,
ao_DESCRIPTION2 STRING,
ao_DESTINATIONNAME INT,
ao_ENTRUCKTIME BIGINT,
ao_ISAGENCYORDER INT,
ao_ISORIGINAL INT,
ao_ISPOOL INT,
ao_MONTH INT,
ao_OEMREGION STRING,
ao_ORDERNR STRING,
ao_ORGANIZATIONSEQ INT,
ao_ORIGINNAME INT,
ao_ORIGINALORDERNR STRING,
ao_PLANDATE BIGINT,
ao_QTY INT,
ao_REALLYCARRIER INT,
ao_REGIONNAME INT,
ao_ROUTENAME INT,
ao_SHOULDCARRIER INT,
ao_STATE INT,
ao_TYPE INT,
ao_UPDATEDAT BIGINT,
ao_UPDATEDUSERSEQ INT,
ao_YEAR INT,
ao_DEPARTMENTSEQ INT,
ao_SHOULDCARRIERSEQ INT,
ao_REALLYCARRIERSEQ INT,
ao_REGIONNAMES STRING,
ao_ISSEGMENTED INT,
ao_RELATEDORGANIZATION STRING,
ao_ACTUALORIGINCITYSEQ INT,
ao_ACTUALDESTINATIONCITYSEQ INT,
ao_RELATEDAGENCY STRING,
ao_RELATEDAGENCYSEQS STRING,
ao_CARRIERDATE BIGINT,
ao_RELATEDORDERS STRING,
ao_DESCRIPTION STRING,
ao_BRANDSTR STRING,
ad_SEQ INT,
ad_AFTERCARTYPE STRING,
ad_CARTYPE STRING,
ad_CODE STRING,
ad_CREATETYPE INT,
ad_CREATEDAT BIGINT,
ad_CREATEDUSERSEQ INT,
ad_DAY INT,
ad_DEALERNAME STRING,
ad_DESCRIPTION STRING,
ad_DESTINATIONNAME INT,
ad_ISSELECTED INT,
ad_MONTH INT,
ad_ORDERSEQ INT,
ad_ORDERNR STRING,
ad_ORGANIZATIONSEQ INT,
ad_ORIGINNAME INT,
ad_PLANDATE BIGINT,
ad_REGIONNAME INT,
ad_STATE INT,
ad_TRANSPORTNR STRING,
ad_UPDATEDAT BIGINT,
ad_UPDATEDUSERSEQ INT,
ad_VIN STRING,
ad_YEAR INT,
ad_REGIONNAMES STRING,
ad_ISSEGMENTED INT,
ad_ASSIGNORDERSEQ INT,
ad_ACTUALORIGINCITYSEQ INT,
ad_ACTUALDESTINATIONCITYSEQ INT,
ad_ENTRUCKTIME BIGINT,
tskod_SEQ INT,
tskod_ASSIGNORDERSEQ INT,
tskod_CODE STRING,
tskod_CREATEDAT BIGINT,
tskod_CREATEDUSERSEQ INT,
tskod_DESCRIPTION STRING,
tskod_TASKMANAGEMENTSEQ INT,
tskod_UPDATEDAT BIGINT,
tskod_UPDATEDUSERSEQ INT,
tsk_SEQ INT,
tsk_ACTUALARRIVALTIME BIGINT,
tsk_ACTUALDEPARTURETIME BIGINT,
tsk_BACKGROUND INT,
tsk_CARQTY INT,
tsk_CARRIERMESSAGE STRING,
tsk_CHECKDATE BIGINT,
tsk_CODE STRING,
tsk_CREATEDAT BIGINT,
tsk_CREATEDUSERSEQ INT,
tsk_CURRENTPLACE STRING,
tsk_DAY INT,
tsk_DESCRIPTION STRING,
tsk_DESPATCHPLANINDATE BIGINT,
tsk_DESTINATIONNAME INT,
tsk_ENTRUCKINGDATE BIGINT,
tsk_HEAVYDRIVINGTASK INT,
tsk_ISCHECK INT,
tsk_ISPAYABLE INT,
tsk_MONTH INT,
tsk_ORGANIZATIONSEQ INT,
tsk_ORIGINNAME INT,
tsk_PLANDATE BIGINT,
tsk_PLANARRIVALTIME BIGINT,
tsk_PLANDEPARTURETIME BIGINT,
tsk_QTY INT,
tsk_REALLYCARRIER INT,
tsk_REGIONSEQ INT,
tsk_RELATEDWAYBILL STRING,
tsk_ROUTENAME INT,
tsk_STATE INT,
tsk_TASKNUMBER STRING,
tsk_TASKTYPE INT,
tsk_TRANSEXPECTTIME BIGINT,
tsk_TYPE INT,
tsk_UPDATEDAT BIGINT,
tsk_UPDATEDUSERSEQ INT,
tsk_YEAR INT,
tsk_DEPARTMENTSEQ INT,
tsk_DELIVERYCARDATE BIGINT,
tsk_RELATEDORGANIZATION STRING,
tsk_CARRIERTYPE INT,
tsk_DISTRIBUTIONCARUSERSEQ INT,
tsk_DISTRIBUTIONCARUSERDATE BIGINT,
tsk_RELATEDAGENCY STRING,
tsk_RELATEDAGENCYSEQS STRING,
tsk_LONGITUDE FLOAT,
tsk_LATITUDE FLOAT,
tsk_ISGENERATEEMPTY INT,
tsk_ISROLLBACKTASK INT,
tsk_RELATEDORDERS STRING,
tsk_NEXTCARRIERTYPE INT,
tsk_BRANDSTR STRING,
tsk_WAYBILLNR STRING,
RecordSource STRING,
WayBillHK STRING,
OrderHK STRING,
AssignOrderHK STRING,
TaskHK STRING,
WaybillOrderHK STRING,
AssignOrderDetailHK STRING,
AssignOrderTaskHK STRING,
PRIMARY KEY (SEQUENCE,LoadDate)
-- PRIMARY KEY (id, sku)
)
PARTITION BY HASH (SEQUENCE) PARTITIONS 6 
--PARTITION BY HASH (id) PARTITIONS 4,
-- RANGE (sku)
-- (
--   PARTITION VALUES < 'g',
--   PARTITION 'g' <= VALUES < 'o',
--   PARTITION 'o' <= VALUES < 'u',
--   PARTITION 'u' <= VALUES
-- )
STORED AS KUDU;
```

> 注：
>
> Kudu建表时，主键字段必须放在建表语句最前面，否则会报错；
>
> HASK分布最好时根据Kudu集群的核心数来配置，可以简单理解为kudu数据库的并发写入，即HASH对应的是纵向切分的tablet（分布在集群各节点）；



> 字段重命名语法： 
>
> ```sql
> ALTER TABLE tms_stage CHANGE TranspotVinHK WaybillOrderHK STRING;
> ```



### 1.7 Loading Script

```sql
SELECT 
ROWNUM as Sequence
,(sysdate- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as LoadDate
,w.ID as w_SEQ
,w.ASSIGNATIONQTY as w_ASSIGNATIONQTY
,w.CODE as w_CODE
,w.CREATETYPE as w_CREATETYPE
,（w.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as w_CREATEDAT
,w.CREATEDUSERID as w_CREATEDUSERSEQ
,w.DAY as w_DAY
,w.DEALERNAME as w_DEALERNAME
,w.DESCRIPTION1 as w_DESCRIPTION1
,w.DESCRIPTION2 as w_DESCRIPTION2
,w.MONTH as w_MONTH
,w.OEMREGION as w_OEMREGION
,w.ORGANIZATIONID as w_ORGANIZATIONSEQ
,w.QTY as w_QTY
,w.REGION as w_REGION
,w.STATE as w_STATE
,w.TRANSPORTNR as w_TRANSPORTNR
,（w.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as w_UPDATEDAT
,w.UPDATEDUSERID as w_UPDATEDUSERSEQ
,（w.WAYBILLDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as w_WAYBILLDATE
,w.YEAR as w_YEAR
,w.DEPARTMENTID as w_DEPARTMENTSEQ
,w.ORIGINNAME as w_ORIGINNAME
,w.DESTINATIONNAME as w_DESTINATIONNAME
,w.AGENCYID as w_AGENCYSEQ
,w.DEALERID as w_DEALERSEQ
,w.FREIGHT as w_FREIGHT
,w.PROVINCEID as w_PROVINCESEQ
,（w.BACKDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as w_BACKDATE
,（w.RECEIPTDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as w_RECEIPTDATE
,w.DESCRIPTION as w_DESCRIPTION
,w.BRANDSTR as w_BRANDSTR
,o.ID as o_SEQ
,o.AFTERCARTYPE as o_AFTERCARTYPE
,o.CARTYPE as o_CARTYPE
,o.COLOR as o_COLOR
,o.CREATETYPE as o_CREATETYPE
,（o.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as o_CREATEDAT
,o.CREATEDUSERID as o_CREATEDUSERSEQ
,o.DAY as o_DAY
,o.DEALERNAME as o_DEALERNAME
,o.DESCRIPTION1 as o_DESCRIPTION1
,o.DESCRIPTION2 as o_DESCRIPTION2
,o.ISPAYABLE as o_ISPAYABLE
,o.MONTH as o_MONTH
,o.OEMREGION as o_OEMREGION
,o.ORGANIZATIONID as o_ORGANIZATIONSEQ
,o.QTY as o_QTY
,o.REGION as o_REGION
,o.STATE as o_STATE
,o.TRANSPORTNR as o_TRANSPORTNR
,（o.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as o_UPDATEDAT
,o.UPDATEDUSERID as o_UPDATEDUSERSEQ
,o.VIN as o_VIN
,o.YEAR as o_YEAR
,o.WAYBILL_ID as o_WAYBILL_SEQ
,o.ORIGINNAME as o_ORIGINNAME
,o.DESTINATIONNAME as o_DESTINATIONNAME
,o.AGENCYID as o_AGENCYSEQ
,o.BENZORDERID as o_BENZORDERSEQ
,o.PROVINCEID as o_PROVINCESEQ
,ao.ID as ao_SEQ
,ao.CODE as ao_CODE
,（ao.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ao_CREATEDAT
,ao.CREATEDUSERID as ao_CREATEDUSERSEQ
,ao.DAY as ao_DAY
,ao.DESCRIPTION1 as ao_DESCRIPTION1
,ao.DESCRIPTION2 as ao_DESCRIPTION2
,ao.DESTINATIONNAME as ao_DESTINATIONNAME
,（ao.ENTRUCKTIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ao_ENTRUCKTIME
,ao.ISAGENCYORDER as ao_ISAGENCYORDER
,ao.ISORIGINAL as ao_ISORIGINAL
,ao.ISPOOL as ao_ISPOOL
,ao.MONTH as ao_MONTH
,ao.OEMREGION as ao_OEMREGION
,ao.ORDERNR as ao_ORDERNR
,ao.ORGANIZATIONID as ao_ORGANIZATIONSEQ
,ao.ORIGINNAME as ao_ORIGINNAME
,ao.ORIGINALORDERNR as ao_ORIGINALORDERNR
,（ao.PLANDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ao_PLANDATE
,ao.QTY as ao_QTY
,ao.REALLYCARRIER as ao_REALLYCARRIER
,ao.REGIONNAME as ao_REGIONNAME
,ao.ROUTENAME as ao_ROUTENAME
,ao.SHOULDCARRIER as ao_SHOULDCARRIER
,ao.STATE as ao_STATE
,ao.TYPE as ao_TYPE
,（ao.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ao_UPDATEDAT
,ao.UPDATEDUSERID as ao_UPDATEDUSERSEQ
,ao.YEAR as ao_YEAR
,ao.DEPARTMENTID as ao_DEPARTMENTSEQ
,ao.SHOULDCARRIERID as ao_SHOULDCARRIERSEQ
,ao.REALLYCARRIERID as ao_REALLYCARRIERSEQ
,ao.REGIONNAMES as ao_REGIONNAMES
,ao.ISSEGMENTED as ao_ISSEGMENTED
,ao.RELATEDORGANIZATION as ao_RELATEDORGANIZATION
,ao.ACTUALORIGINCITYID as ao_ACTUALORIGINCITYSEQ
,ao.ACTUALDESTINATIONCITYID as ao_ACTUALDESTINATIONCITYSEQ
,ao.RELATEDAGENCY as ao_RELATEDAGENCY
,ao.RELATEDAGENCYIDS as ao_RELATEDAGENCYSEQS
,（ao.CARRIERDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ao_CARRIERDATE
,ao.RELATEDORDERS as ao_RELATEDORDERS
,ao.DESCRIPTION as ao_DESCRIPTION
,ao.BRANDSTR as ao_BRANDSTR
,ad.ID as ad_SEQ
,ad.AFTERCARTYPE as ad_AFTERCARTYPE
,ad.CARTYPE as ad_CARTYPE
,ad.CODE as ad_CODE
,ad.CREATETYPE as ad_CREATETYPE
,（ad.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ad_CREATEDAT
,ad.CREATEDUSERID as ad_CREATEDUSERSEQ
,ad.DAY as ad_DAY
,ad.DEALERNAME as ad_DEALERNAME
,ad.DESCRIPTION as ad_DESCRIPTION
,ad.DESTINATIONNAME as ad_DESTINATIONNAME
,ad.ISSELECTED as ad_ISSELECTED
,ad.MONTH as ad_MONTH
,ad.ORDERID as ad_ORDERSEQ
,ad.ORDERNR as ad_ORDERNR
,ad.ORGANIZATIONID as ad_ORGANIZATIONSEQ
,ad.ORIGINNAME as ad_ORIGINNAME
,（ad.PLANDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ad_PLANDATE
,ad.REGIONNAME as ad_REGIONNAME
,ad.STATE as ad_STATE
,ad.TRANSPORTNR as ad_TRANSPORTNR
,（ad.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ad_UPDATEDAT
,ad.UPDATEDUSERID as ad_UPDATEDUSERSEQ
,ad.VIN as ad_VIN
,ad.YEAR as ad_YEAR
,ad.REGIONNAMES as ad_REGIONNAMES
,ad.ISSEGMENTED as ad_ISSEGMENTED
,ad.ASSIGNORDERID as ad_ASSIGNORDERSEQ
,ad.ACTUALORIGINCITYID as ad_ACTUALORIGINCITYSEQ
,ad.ACTUALDESTINATIONCITYID as ad_ACTUALDESTINATIONCITYSEQ
,（ad.ENTRUCKTIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as ad_ENTRUCKTIME
,tskod.ID as tskod_SEQ
,tskod.ASSIGNORDERID as tskod_ASSIGNORDERSEQ
,tskod.CODE as tskod_CODE
,（tskod.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tskod_CREATEDAT
,tskod.CREATEDUSERID as tskod_CREATEDUSERSEQ
,tskod.DESCRIPTION as tskod_DESCRIPTION
,tskod.TASKMANAGEMENTID as tskod_TASKMANAGEMENTSEQ
,（tskod.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tskod_UPDATEDAT
,tskod.UPDATEDUSERID as tskod_UPDATEDUSERSEQ
,tsk.ID as tsk_SEQ
,（tsk.ACTUALARRIVALTIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_ACTUALARRIVALTIME
,（tsk.ACTUALDEPARTURETIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_ACTUALDEPARTURETIME
,tsk.BACKGROUND as tsk_BACKGROUND
,tsk.CARQTY as tsk_CARQTY
,tsk.CARRIERMESSAGE as tsk_CARRIERMESSAGE
,（tsk.CHECKDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_CHECKDATE
,tsk.CODE as tsk_CODE
,（tsk.CREATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_CREATEDAT
,tsk.CREATEDUSERID as tsk_CREATEDUSERSEQ
,tsk.CURRENTPLACE as tsk_CURRENTPLACE
,tsk.DAY as tsk_DAY
,tsk.DESCRIPTION as tsk_DESCRIPTION
,（tsk.DESPATCHPLANINDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_DESPATCHPLANINDATE
,tsk.DESTINATIONNAME as tsk_DESTINATIONNAME
,（tsk.ENTRUCKINGDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_ENTRUCKINGDATE
,tsk.HEAVYDRIVINGTASK as tsk_HEAVYDRIVINGTASK
,tsk.ISCHECK as tsk_ISCHECK
,tsk.ISPAYABLE as tsk_ISPAYABLE
,tsk.MONTH as tsk_MONTH
,tsk.ORGANIZATIONID as tsk_ORGANIZATIONSEQ
,tsk.ORIGINNAME as tsk_ORIGINNAME
,（tsk.PLANDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_PLANDATE
,（tsk.PLANARRIVALTIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_PLANARRIVALTIME
,（tsk.PLANDEPARTURETIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_PLANDEPARTURETIME
,tsk.QTY as tsk_QTY
,tsk.REALLYCARRIER as tsk_REALLYCARRIER
,tsk.REGIONID as tsk_REGIONSEQ
,tsk.RELATEDWAYBILL as tsk_RELATEDWAYBILL
,tsk.ROUTENAME as tsk_ROUTENAME
,tsk.STATE as tsk_STATE
,tsk.TASKNUMBER as tsk_TASKNUMBER
,tsk.TASKTYPE as tsk_TASKTYPE
,（tsk.TRANSEXPECTTIME- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_TRANSEXPECTTIME
,tsk.TYPE as tsk_TYPE
,（tsk.UPDATEDAT- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_UPDATEDAT
,tsk.UPDATEDUSERID as tsk_UPDATEDUSERSEQ
,tsk.YEAR as tsk_YEAR
,tsk.DEPARTMENTID as tsk_DEPARTMENTSEQ
,（tsk.DELIVERYCARDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_DELIVERYCARDATE
,tsk.RELATEDORGANIZATION as tsk_RELATEDORGANIZATION
,tsk.CARRIERTYPE as tsk_CARRIERTYPE
,tsk.DISTRIBUTIONCARUSERID as tsk_DISTRIBUTIONCARUSERSEQ
,（tsk.DISTRIBUTIONCARUSERDATE- to_date('1970-01-01 ','yyyy-mm-dd')) * 86400000 as tsk_DISTRIBUTIONCARUSERDATE
,tsk.RELATEDAGENCY as tsk_RELATEDAGENCY
,tsk.RELATEDAGENCYIDS as tsk_RELATEDAGENCYSEQS
,CAST (tsk.LONGITUDE AS DECIMAL(10,2))as tsk_LONGITUDE
,CAST (tsk.LATITUDE AS DECIMAL(10,2))as tsk_LATITUDE
,tsk.ISGENERATEEMPTY as tsk_ISGENERATEEMPTY
,tsk.ISROLLBACKTASK as tsk_ISROLLBACKTASK
,tsk.RELATEDORDERS as tsk_RELATEDORDERS
,tsk.NEXTCARRIERTYPE as tsk_NEXTCARRIERTYPE
,tsk.BRANDSTR as tsk_BRANDSTR
,tsk.WAYBILLNR as tsk_WAYBILLNR


-- 以下为派生列生成部分 
,'TMS' as RecordSource
,(case when w.TRANSPORTNR is not null then MD5(w.TRANSPORTNR) else null end ) as WayBillHK
,(case when w.TRANSPORTNR is not null and o.TRANSPORTNR is not null and o.VIN is not null then MD5(concat(w.TRANSPORTNR,concat(o.TRANSPORTNR,o.VIN))) else null end )as WaybillOrderHK
,(case when o.TRANSPORTNR is not null and o.VIN is not null  then MD5(concat(o.TRANSPORTNR,o.VIN)) else null end ) as OrderHK
,(case when o.TRANSPORTNR is not null and o.VIN is not null and ao.ORDERNR is not null  then MD5(concat(o.TRANSPORTNR,concat(o.VIN,ao.ORDERNR))) else null end ) as AssignOrderDetailHK
,(case when ao.ORDERNR is not null then MD5(ao.ORDERNR) else null end ) as AssignOrderHK
,(case when ao.ORDERNR is not null and tsk.TASKNUMBER is not null  then MD5(concat(ao.ORDERNR,tsk.TASKNUMBER)) else null end ) as AssignOrderTaskHK
,(case when tsk.TASKNUMBER is not null then MD5(tsk.TASKNUMBER) else null end ) as TaskHK

from WAYBILL w 
LEFT JOIN ORDERS o on (w.transportnr = o.transportnr)
LEFT JOIN ASSIGNORDERDETAIL ad on ( o.VIN = ad.VIN and o.transportnr = ad.transportnr )
LEFT JOIN ASSIGNORDER ao on (AD.ORDERNR=AO.ORDERNR)
LEFT JOIN TASKORDERRELATION tskod on (AO."ID"=TSKOD.ASSIGNORDERID)
LEFT JOIN TASKMANAGEMENT tsk on (TSKOD.TASKMANAGEMENTID=TSK."ID")
where 
-- w.CREATEDAT > TO_DATE('2018-06-01', 'yyyy-mm-dd')
-- w.CREATEDAT > TO_DATE('2018-10-14', 'yyyy-mm-dd')
w.TRANSPORTNR in ('B20180000027310','B20180000027242')
```



## 2.ETL流程数据库链接服务配置

设计流程：

1. 配置数据库链接服务：Oracle JDBC 驱动，Impala JDBC驱动
2. 将数据导入Stage库对应表

### 2.1 Oracle DBCP( JDBC )

| Property                    | Value                                     |
| --------------------------- | ----------------------------------------- |
| Database Connection URL     | jdbc:oracle:thin:@42.121.111.38:1521:ORCL |
| Database Driver Class Name  | oracle.jdbc.driver.OracleDriver           |
| Database Driver Location(s) | /nfs/data/usr/ojdbc6.jar                  |
| Database User               | localtms                                  |
| Password                    | Sensitive value set                       |
| Max Wait Time               | 500 millis                                |
| Max Total Connections       | 8                                         |
| Validation query            | No value set                              |

> 疑点：
>
> 此处没有指定是在哪个库(Schema)执行，但是为什么在执行脚本是任然可以直接操作 LocalTMS 库相关表？



### 2.2 Impala DBCP( JDBC )

### 

| Property                    | Value                                      |
| --------------------------- | ------------------------------------------ |
| Database Connection URL     | jdbc:impala://47.96.114.97:21050/tms_stage |
| Database Driver Class Name  | com.cloudera.impala.jdbc41.Driver          |
| Database Driver Location(s) | /opt/nifi-1.6.0/ImpalaJDBC41.jar           |
| Database User               | admin                                      |
| Password                    | Sensitive value set                        |
| Max Wait Time               | 500 millis                                 |
| Max Total Connections       | 8                                          |
| Validation query            | No value set                               |





## 3. Data Vault And Staging Area

Posted on 2010/08/18 by [Dan Linstedt](https://danlinstedt.com/author/dlinstedt/)	 in [Data Vault](https://danlinstedt.com/category/allposts/datavaultcat/), [ETL /ELT](https://danlinstedt.com/category/allposts/etlelt/)

I’m often asked about the Data Vault, and the Staging Area – when to use it, why to use it, how to use it – and what the best practices are around using it.  Those of you who’ve been through my training, understand that there is a LOT of ground to cover, and I cover all of this (and more) with examples, inside my one-on-one coaching area.  That said, I will answer some of the above questions here in this brief post.  This post is **focused** on batch processing and micro batch processing.  This post **does not** answer the real-time feed questions.

### 3.1 What is a STAGING AREA?

集结区`staging area`（也称登陆区`landing zones`）一般与DataVault位于同一服务器系统`server `中，但并非强制要求。

> A staging area is used in **batch load** situations.  A staging area (typically) is a location on the same server as the data warehouse in order to eliminate network traffic between the ETL from the staging area and the data warehouse.  Notice that I didn’t restrict the definition of staging area to database only…  This is absolutely CRITICAL.  Sometimes staging areas are also called **landing zones** for flat files, XML files, Cobol files and the like.



### 3.2 What is in the architecture of the staging area?

集结区保存着独立表格/文件等，整体流程为：***Data Ready –> Logon to source –> Get Data in parallel process as fast as possible –> put data in staging area as fast as possible –> logout of source.*** 

集结区支持` Truncate` 和`re-load`  ，从而使该流程完全可以重新启动；

> The architecture is: INDEPENDENT TABLES / FILES that “arrive” when the data is ready on the source.  The whole point to staging batch data is: ***Data Ready –> Logon to source –> Get Data in parallel process as fast as possible –> put data in staging area as fast as possible –> logout of source.***  By having them be independent, (no foreign keys, no referential integrity, no lookups, no matches, no checks of any kind) our IT team can be agile and fast when new systems are due to be added to the EDW, our processes are optimized to scale at high speed (whether or not we have BIG DATA to deal with).  Truncate and re-load makes the processes completely restartable.

### 3.3 What are the reasons for using a staging area?

- Scalability（支持并行处理） – able to partition the structures as needed, able to add new parallel processes as needed
- Flexibility（可快速扩展） – able to absorb new feeds, new columns, new systems QUICKLY
- Dynamic – able to load *optional* feeds that have undetermined arrival dates/times (inconsistent feeds, or on-demand feeds)
- Restartable（支持重新加载失败部分） – able to restart the PART of the load that failed, after the problem is fixed – WITHOUT affecting all the other feeds
- Schedule （支持规划）– able to schedule the stage load WHENEVER the data on the source is ready, this removes serious timing depenendancies across the system (which hinder scalability and flexibility)
- Backup and Restore （支持备份）– After the entire staging area is “loaded” for a load cycle, ***I like to back it up, zip it, timestamp it, and compress it – then check it in to a Version control system.***  This provides me with auditability along the way, as well as full restoration capabilities.（可备份的，数据加载过后可以将stage压缩并保存起来）

### 3.4 Why split the staging area from the Data Vault?

The Data Vault is meant to have data warehousing abilities.  The structures contain indicies, primary and foreign keys.  The data being loaded to the Data Vault generally has a specific order (in batch only) – in order to tell the story of `which system is actually delivering the data at what date/time`.  When you add these structural components to the data model, you push “processing sequences” up-stream.  If you were to use a Data Vault (empty or truncated every load cycle) as the staging area, you would **lose** all the performance benefits, and flexibility benefits, and scheduling benefits from the list above.

Restartability, backup and restore are still built in to the Data Vault.  Don’t get me wrong…. Performance benefits are in the Data Vault model too – they just are viewed slightly differently.

Using a Data Vault model as a staging area causes you to have to “worry” about availability and timing of the data set from the multiple source systems ***ALWAYS TRY TO THINK IN TERMS OF MULTIPLE SOURCE SYSTEMS*** Data Warehousing folks sometimes make the mistake of thinking of only ONE source system when architecting their solutions.

### 3.5 What about ETL Performance and Ease of Load?

Well, I’ve blogged on this many many times, in many places around the web.  I’m currently building best-practices, explaining why, how, and the mathematics behind it all – inside the [coaching ](http://danlinstedt.com/my-coach)area.  But I’ll give you some information here that might make sense.

Despite what you might think (ie: it’s easier to go from source straight to Data Vault…) – this is not true.  Especially in systems of scale or size.  Source to Data Vault means you push all the multi-system dependencies and availability of data issues *up-stream* back to the base loading cycle.  The problem is: you have one source feed ready at 10pm the previous night, and another source feed ready at 4am the following morning.  Well, if they both load the Satellite, or Link, or Hub – they have to be synchronized.  Especially if the 4am feed is the MASTER system.  Now, you end up “waiting” to run the 10pm load cycle until after the 4am (next morning) feed is done.

Well, what happens if the source system for the first feed is only available from 10pm to 12am, and then the window closes?

Cross-Feed Dependencies (based on timing/availability) are one of the **major** reasons why EDW/BI projects become **in-flexible** and **non-agile** as time goes on.  These cross-feed dependencies (as described) are based on **timing and availability** of the data.  Which the system admins of those sources are constantly wanting to change the schedules around – re-prioritize the jobs.  This by itself, usually leads to **HUGE re-engineering efforts,** SUPER HIGH COSTS for maintenance, and the beginning of the downfall of the EDW/BI system!!  This is where the source of the problems for business users funding the BI effort start to occur.

It’s eventually what **forces** a business to **shut-down and re-build** (from the ground up) the **entire** data warehouse.  It’s the **cause** of the problem.

I’m sorry to be so adamant about this, but I’ve seen it in hundreds of business intelligence projects.  I’ve also helped some of these companies avoid this pain in the future by moving to the Data Vault and following the standard and best practices that I’ve setup and defined.

ETL Performance:  ETL or EL, or ELT (doesn’t matter) is 4x to 10x slower when loading a table with Primary/Foreign keys, and indexes ON when compared to an empty, truncated table with no Primary/foreign keys, and no indexes.  These factors **matter**.  Especially when the data set grows from 40 million to 400 million or to 1 billion rows to load PER PROCESS.

ETL Performance to the Data Vault is fast, IF the staging area is in the database to begin with.  There are ways to get the database to “bypass logging”, shut-down indexes, delay foreign key checks, etc…  if the operations are executed IN DATABASE.

ETL Performance slows down IF you go from **source** to Data Vault because of the **timing issues**, as well as the remote connection and IP transfer restrictions.  NOTE: THIS IS *NOT* A PROBLEM OF REAL-TIME or BURST DATA ARRIVAL.

Ease of load: Well, it’s easier to load a STANDARD staging table (to me) that mimics the source system, than it is to try and normalize the data (if I were to go from the source to the Data Vault directly).  Once all the data is SQL accessible, has been aligned (datatypes only!!), and duplicates have been removed – then it becomes easy to load from stage to vault.

If you try to combine data type alignment, accessibility (direct to source), timing/availability, duplicate removal, source system ordering of load processes, and normalization in to a SINGLE ETL process, you then are **increasing** (dramatically) the complexity factor of your source-to-warehouse load.  When you increase the complexity ratings, your ability to remain agile as a solutions team begins to drop.  Your ability to maintain the system in an efficient and timely manner begins to drop.  Your ability to add new systems FAST begins to drop.

There are too many benefits dropped (including scalability and flexibility) to use the Data Vault model as a staging area.  But this is just my opinion.

### 3.6 SEQUENCE NUMBERS….

I posted a blog entry on sequences recently, but here’s the gist: Sequence numbers in the staging area should stay in the staging area.  They are good for ONE THING ONLY in the staging area: identification and removal of **true duplicate rows**.  They should always start at 1 for new batch load cycles.  They always need to be unique, but don’t need to be in order.  This allows you to use this standard approach on ANY database system (columnar, appliance, MPP, SMP, clustered… whatever).  Sequences in the Data Vault are there to stay, and are to be used as fast-join placeholders in the vault – they represent a 1:1 relationship with the business keys.

Do any of you have a different opinion?  Do you agree with me?  What do you think about this subject?  Pros and Cons?  Register for the blog FOR FREE, then add your comment.

Cheers,
Dan L
PS: Don’t forget – there is a wide array of lessons about agility, flexibility, scalability, and architecture inside my on-line lessons at: [http://LearnDataVault.com](http://learndatavault.com/)



## Reference

[Data Vault And Staging Area](https://danlinstedt.com/allposts/datavaultcat/data-vault-and-staging-area/)

[Data Vault - Hub Loads explained（中心表从source到datavault流程示例）](https://www.oraylis.de/blog/data-vault-hub-loads-explained)
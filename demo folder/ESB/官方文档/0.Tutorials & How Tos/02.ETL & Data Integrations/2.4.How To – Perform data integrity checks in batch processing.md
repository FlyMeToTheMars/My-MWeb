# [HowTo – Data Integrity checks in batch processing](https://blogs.mulesoft.com/dev/howto/howto-data-integrity-checks-in-batch-processing/)

We recently introduced our  [HowTo](https://blogs.mulesoft.com/dev/howto/) blog series, which is designed to present simple use-case tutorials to help you as you evaluate Mulesoft’s [Anypoint Platform](https://www.mulesoft.com/platform/enterprise-integration). This blog post is a follow up to our last blog “[How to ETL](https://blogs.mulesoft.com/dev/howto/howto-extract-transform-load-etlchange-data-capture/)” using Mule. In that post, we demonstrated how [Anypoint Platform](http://www.mulesoft.com/platform/enterprise-integration) could be leveraged to read a large number of messages, transform/enrich these messages, and then load them into a target system/application.

One of the biggest issues while processing multiple messages is handling unclean data. [Anypoint Platform](http://www.mulesoft.com/platform/enterprise-integration) is designed to ease the burden of [data integration](https://blogs.mulesoft.com/tag/data-integration/);  data integrity checks are a very important component of the process. It’s crucial to have such a check in place so as to avoid a proliferation of bad data to downstream applications.

**In the previous blog post, we polled for all new order records in a MySQL database table(extract). For each order record, we do the following –**

1. Look up the product details for each SKUs using SKU number in the record.
2. Look up the order status for the order using Order ID in the record.
3. Insert the merged data with product details and order status into the Status Report table

**We are now adding the following data integrity checks to this process:**

- Deduplicate records in the source table based on Order ID
- Ensure that all the required fields in the payload are present
- Ensure the value of the fields such as Order ID is between 1 – 10000
- Ensure the length of the retailer name is not greater than 70 characters

If there is an error in any of these checks, we insert an error record with the appropriate error message into the ORDERS_ERRORS table.

**Pre-requisites:**

- [Anypoint Platform](http://www.mulesoft.com/platform/enterprise-integration) – [MuleSoft](https://www.google.com/url?q=https://www.mulesoft.com/platform/studio&sa=D&ust=1452800878993000&usg=AFQjCNHgSkemUpQ0C6vpmDNBNciC8SfSbA)[ Anypoint Studio](https://www.mulesoft.com/platform/studio).
- A database where we can create and load a sample table required for this project. In this example, we will use an instance of the [MySQL database](https://www.mysql.com/).
- [Download](https://dev.mysql.com/downloads/connector/j/5.0.html) the latest MySQL database driver jar file.
- The Mule project downloadable from [Anypoint Exchange](https://anypoint.mulesoft.com/exchange/).
- To follow the example in this guide, run the SQL script order.sql to set up the database and tables and load them with some sample data. You will find the order_integrity.sql file in the [project](https://anypoint.mulesoft.com/exchange/) under the folder src/main/resources

## Data Integrity Check Steps:

1. Start Mulesoft [Anypoint Studio](http://www.mulesoft.com/platform/mule-studio) and point to a new workspace.
2. Import the completed [project](https://www.mulesoft.com/exchange/#!/Extract-Transform-Load-Using-Batch) from the previous [ETL blog post](https://blogs.mulesoft.com/dev/howto/howto-extract-transform-load-etlchange-data-capture/). Click on File -> Import -> [Anypoint Studio](http://www.mulesoft.com/platform/mule-studio) Deployable Studio Archive -> dbetl.zip. Rename the project to “data integrity”.[![howto3_1](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1024x561.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog.png)
3. Add the transform message transformer ([DataWeave](https://www.mulesoft.com/integration-solutions/dataweave-integration)) from the palette into the flow after the “Capture Changed Records” poller component. Rename the component to “Deduplicate records using Order ID”. Configure the [DataWeave](https://www.mulesoft.com/integration-solutions/dataweave-integration) transformer by using the following transform expression – “payload distinctBy $.OrderID”. You can also optionally set the metadata for the output to define a map object called Order as shown below – [![howto3_2](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1024x576.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog.png)
4. Add a batch step before the “Transform_QuerySKU” step. Rename it to “DataIntegrityCheck” as shown below –
5. [![howto3_3](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1-1024x572.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1.png)Add the [DataWeave](https://www.mulesoft.com/integration-solutions/dataweave-integration) transformer into this new batch step and rename it “Transform to JSON”. This transformer is used to convert the map object into a JSON string as shown below. You can also optionally set the metadata for the output JSON structure.[![Howto3_4](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-2-1024x532.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Menubar_and_Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-2.png)
6. Copy the completed JSON schema file order_json_schema.json from the src/main/resources folder of the downloaded project into the corresponding folder in your project as shown below – [![howto3_5](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_test_resources_order_json_schema_json_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1024x564.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_test_resources_order_json_schema_json_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog.png)
7. Search for the “Validate JSON Schema” component in the palette and drop it into the Mule flow after the “Transform to JSON” component. Configure it as shown below to use the JSON schema file – [![howto3_6](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1-1024x558.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-1.png)
8. Drag and drop the “JSON to Object” transformer from the Palette into the flow. This transformer converts the JSON back into a Hash map. Configure it as shown below – [![Howto3_7](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-2-1024x558.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-2.png)
9. Insert a batch step at the end of the mule flow to handle and log failed records. Configure it as shown below to accept “ONLY_FAILURES” –[![Howto3_9](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-3-1024x562.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-3.png)
10. When the message enters the “FailedRecords” step, it comes as a byte array. Insert the byte array to object transformer in the flow to convert the message back to an object using the configuration as shown below –[![Howto3_10](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-4-1024x564.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-4.png)
11. Insert a [DataWeave](https://www.mulesoft.com/integration-solutions/dataweave-integration) transformer to convert the JSON object into a Java hashmap so that we can extract individual values from the payload. Rename the component to “Convert JSON to Object” and configure it as shown below. You can also optionally set the metadata for the source and target to show the Order map object. [![Howto3_11](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-5-1024x561.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-5.png)
12. Insert a Variable component from the palette into the Mule flow after the [DataWeave](https://www.mulesoft.com/integration-solutions/dataweave-integration) transformer. Rename it to “Store exception” and configure it to store the exception into a variable called “exception”. Use the following MEL(Mule Expression Language) expression to store the variable – “#[getStepExceptions()]”[![Howto3_12](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-6-1024x563.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-6.png)
13. Insert a database [connector](https://www.mulesoft.com/exchange#!/?types=connector) from the palette after “Store Exception”. Rename this to “Insert Error” as this would be used to insert the error records into a separate table. Configure it as shown below with the following SQL statement – “INSERT INTOORDERS_ERRORS(OrderID,RetailerName,SKUs,OrderDate,Message) VALUES (#[payload.OrderID],#[payload.RetailerName],#[payload.SKUs],#[payload.OrderDate],#[flowVars.exception.DataIntegrityCheck.message])”[![Howto3_13](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-7-1024x551.png)](https://blogs.mulesoft.com/wp-content/uploads/2016/04/Mule_Design_-_dataintegrity_src_main_app_dbetl_xml_-_Anypoint_Studio_-__Users_manansanghvi_AnypointStudio_self_howtoblog-7.png)

**To create this flow we have leveraged the following features of Anypoint Platform:**

- [Batch processing](https://docs.mulesoft.com/mule-user-guide/v/3.6/batch-processing) module along with the [watermarking](https://docs.mulesoft.com/mule-user-guide/v/3.7/poll-reference#polling-for-updates-using-watermarks) feature which can be used in any scenario to capture change data for a large number of records.
- [Database Connector](https://docs.mulesoft.com/mule-user-guide/v/3.7/database-connector): Allows you to connect to almost any relational database.
- [DataSense](https://docs.mulesoft.com/mule-user-guide/v/3.7/datasense) uses message metadata to facilitate application design.
- [Mule Expression Language (MEL):](https://docs.mulesoft.com/mule-user-guide/v/3.6/mule-expression-language-mel) Lightweight Mule-specific expression language that can be used to access/evaluate the data in the payload.
- [Transformers](https://docs.mulesoft.com/mule-user-guide/v/3.7/transformers)/[DataWeave](https://docs.mulesoft.com/mule-user-guide/v/3.7/dataweave-reference-documentation):  A simple, powerful way to query and transform data using the platform.

As you can see from the above example, it is not only straightforward to setup a variety of ETL scenarios using [Anypoint Platform](http://www.mulesoft.com/platform/enterprise-integration), but you can also include a sophisticated data integrity component to weed out the “bad” data. In this way, you can ensure that the downstream systems only have good data. The error records which are persisted to an error table can be fixed in the source system and then retried again.

------

Sign up for our **blog newsletter** on the **top right corner** of the page to stay up to date on all of our releases and posts!